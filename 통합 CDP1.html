<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>퍼플아이오 통합 CDP 셀프진단</title>
  <style>
    body { font-family: 'Arial', sans-serif; margin: 0; padding: 0; background: #f9f9f9; }
    .header {
      width: 100%; background: linear-gradient(90deg, #5A4FCF, #7A63F4);
      color: white; text-align: center; padding: 30px;
    }
    .header h1 { margin: 0; font-size: 1.8em; }
    .header p { margin-top: 10px; font-size: 1.1em; }
    .container {
      max-width: 1000px; margin: 30px auto; padding: 25px;
      background: white; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .question { margin-bottom: 25px; text-align: left; }
    label { font-weight: bold; display: block; margin-bottom: 8px; }
    select, input[type="text"], textarea {
      width: 100%; padding: 8px; margin-top: 5px;
      border: 1px solid #ccc; border-radius: 5px; font-size: 1em;
    }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; vertical-align: top; }
    th { background: #f0f0f0; }
    td { white-space: pre-wrap; word-break: break-word; }
    .btn-area { margin-top: 30px; text-align: center; }
    .btn {
      padding: 12px 25px; font-size: 1em; border: none; border-radius: 30px;
      background: linear-gradient(90deg, #5A4FCF, #7A63F4); color: white; cursor: pointer;
    }
    .btn:hover { opacity: 0.9; }
    .btn-secondary { background: #ccc; color: #333; }
    .hidden { display: none; }
    .goal-box { background: #f8f6ff; border-left: 5px solid #5A4FCF;
                padding: 15px; margin-top: 15px; border-radius: 5px; }
    .highlight { font-weight: bold; color: #5A4FCF; }
  </style>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getStorage, ref, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBp2CN3ZoPu7Wfzh_6qr0Tnw3wNuoXwU3I",
      authDomain: "self-cdp1.firebaseapp.com",
      projectId: "self-cdp1",
      storageBucket: "self-cdp1.firebasestorage.app",
      messagingSenderId: "1020721578797",
      appId: "1:1020721578797:web:673317f387ff17fc4dc9a4"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // ✅ 문항 불러오기
    async function loadQuestions() {
      try {
        const url = await getDownloadURL(ref(storage, "questions.json"));
        const response = await fetch(url);
        const data = await response.json();
        window.questionsData = data;
        console.log("문항 로딩 완료 ✅");

        // 기본 정보 가져오기
        const team = document.getElementById("teamSelect").value;
        const part = document.getElementById("partSelect").value;
        const role = document.getElementById("roleSelect").value;

        // Soft Skill
        const softQuestions = data.filter(q =>
          q.domain === "SoftSkill" &&
          q.team === team && (!q.part || q.part === part) && (!q.role || q.role === role)
        );
        renderQuestions(softQuestions, "softskill-questions");

        // Hard Skill
        const hardQuestions = data.filter(q =>
          q.domain === "HardSkill" &&
          q.team === team && (!q.part || q.part === part) && (!q.role || q.role === role)
        );
        renderQuestions(hardQuestions, "hardskill-questions");

      } catch (err) {
        console.error("문항 로딩 오류:", err);
      }
    }

    // ✅ 문항 렌더링
    function renderQuestions(questions, containerId) {
      const container = document.getElementById(containerId);
      container.innerHTML = "";

      questions.forEach((q, idx) => {
        const div = document.createElement("div");
        div.classList.add("question");

        if (q.type === "choice") {
          div.innerHTML = `
            <label>${idx + 1}. ${q.question}</label>
            <select required>
              <option value="">선택하세요</option>
              ${q.options.map(opt => `<option>${opt}</option>`).join("")}
            </select>
            ${q.etc ? `<input type="text" placeholder="기타 의견 작성">` : ""}
          `;
        }

        if (q.type === "scale") {
          div.innerHTML = `
            <label>${idx + 1}. ${q.question} (${q.competency})</label>
            ${["상","중","하","경험없음"].map(level =>
              `<label><input type="radio" name="${containerId}-scale-${idx}" value="${level}">${level}</label>`
            ).join("")}
            <p style="font-size:0.8em;color:#888;">조직 필요 수준: ${q.org_level}</p>
          `;
        }

        if (q.type === "text") {
          div.innerHTML = `
            <label>${idx + 1}. ${q.question}</label>
            <textarea rows="4" style="width:100%;"></textarea>
          `;
        }

        container.appendChild(div);
      });
    }

    // ✅ 응답 수집
    function collectAnswers(containerId) {
      const answers = [];
      let valid = true;

      document.querySelectorAll(`#${containerId} .question`).forEach(q => {
        const label = q.querySelector("label").innerText;
        const select = q.querySelector("select");
        const radios = q.querySelectorAll("input[type=radio]");
        const textarea = q.querySelector("textarea");
        const input = q.querySelector("input[type=text]");

        let value = "";
        if (select) value = select.value;
        if (radios.length > 0) {
          const checked = [...radios].find(r => r.checked);
          value = checked ? checked.value : "";
        }
        if (textarea) value = textarea.value;
        if (input && input.value) value += " (기타: " + input.value + ")";

        if (!value) {
          alert(`${label}에 응답해주세요.`);
          valid = false;
          return;
        }

        answers.push({ question: label, answer: value });
      });

      return valid ? answers : null;
    }

    // ✅ 화면 이동 & 저장
    window.goToNameInput = function() {
      document.getElementById("start-screen").classList.add("hidden");
      document.getElementById("name-screen").classList.remove("hidden");
    }

    window.goBackToStart = function() {
      document.getElementById("name-screen").classList.add("hidden");
      document.getElementById("start-screen").classList.remove("hidden");
    }

    window.goToSoftSkill = function() {
      const team = document.getElementById("teamSelect").value.trim();
      const part = document.getElementById("partSelect").value.trim();
      const role = document.getElementById("roleSelect").value.trim();
      const name = document.getElementById("username").value.trim();

      if (!team || !part || !role || !name) {
        alert("모든 기본 정보를 입력해주세요!");
        return;
      }

      loadQuestions();

      document.getElementById("name-screen").classList.add("hidden");
      document.getElementById("softskill-screen").classList.remove("hidden");
    }

    window.validateSoftSkill = function() {
      const answers = collectAnswers("softskill-questions");
      if (!answers) return;
      window.softSkillAnswers = answers;

      document.getElementById("softskill-screen").classList.add("hidden");
      document.getElementById("hardskill-screen").classList.remove("hidden");
    }

    window.validateHardSkill = function() {
      const answers = collectAnswers("hardskill-questions");
      if (!answers) return;
      window.hardSkillAnswers = answers;

      document.getElementById("hardskill-screen").classList.add("hidden");
      document.getElementById("goal-screen").classList.remove("hidden");
    }

    window.goBackToHardSkill = function() {
      document.getElementById("goal-screen").classList.add("hidden");
      document.getElementById("hardskill-screen").classList.remove("hidden");
    }

    window.validateGoal = async function() {
      const goalText = document.getElementById("personal-goal").value.trim();
      if (!goalText) {
        alert("개인 성장 목표를 작성해주세요.");
        return;
      }

      const team = document.getElementById("teamSelect").value.trim();
      const part = document.getElementById("partSelect").value.trim();
      const role = document.getElementById("roleSelect").value.trim();
      const name = document.getElementById("username").value.trim();

      const allAnswers = [
        ...window.softSkillAnswers,
        ...window.hardSkillAnswers,
        { question: "개인 성장 목표", answer: goalText }
      ];

      try {
        await addDoc(collection(db, "surveyResponses"), {
          team, part, role, name,
          answers: allAnswers,
          personalGoal: goalText,
          timestamp: serverTimestamp()
        });
        alert("설문이 저장되었습니다 ✅");
      } catch (e) {
        console.error("저장 오류:", e);
      }

      document.getElementById("goal-screen").classList.add("hidden");
      document.getElementById("result-screen").classList.remove("hidden");
      document.getElementById("goal-section").innerText = goalText;
    }
  </script>
</head>
<body>

  <!-- (1) 설명 화면 -->
  <div id="start-screen">
    <div class="header"><h1>퍼플아이오 통합 CDP 셀프진단</h1></div>
    <div class="container">
      <p>CDP 셀프진단에 오신 것을 환영합니다.<br><br>
         이 진단은 <b>공통 역량과 도메인별 실무 역량</b>을 종합적으로 확인하여
         여러분의 현재 수준을 살펴보고, 개인별 성장 계획과 교육 지원에 활용됩니다.<br><br>
         각 문항을 읽고 본인의 실제 수행 수준에 가장 가까운 선택지를 선택해 주세요.<br>
         필요 시 “기타 의견 작성”란에 구체적인 경험이나 보완 의견을 자유롭게 남기실 수 있습니다.<br><br>
         모든 답변은 자기 개발을 위한 참고 자료로만 사용되니,<br>
         편안하고 솔직하게 응답해 주시기 바랍니다.</p>
      <div class="btn-area">
        <button class="btn" onclick="goToNameInput()">진단 시작하기</button>
      </div>
    </div>
  </div>

  <!-- (2) 기본 정보 입력 -->
  <div id="name-screen" class="hidden">
    <div class="header"><h1>기본 정보 입력</h1></div>
    <div class="container">
      <div class="question">
        <label>팀 *</label>
        <select id="teamSelect">
          <option value="">선택하세요</option>
          <option value="서비스플랫폼개발팀">서비스플랫폼개발팀</option>
          <option value="커머스플랫폼개발팀">커머스플랫폼개발팀</option>
          <option value="Vertical Part">Vertical Part</option>
        </select>
      </div>
      <div class="question">
        <label>파트 *</label>
        <select id="partSelect">
          <option value="">선택하세요</option>
          <option value="CRM개발 Part">CRM개발 Part</option>
          <option value="WMS개발 Part">WMS개발 Part</option>
          <option value="파트너오피스개발 Part">파트너오피스개발 Part</option>
          <option value="Vertical Part">Vertical Part</option>
        </select>
      </div>
      <div class="question">
        <label>직무 *</label>
        <select id="roleSelect">
          <option value="">선택하세요</option>
          <option value="풀스택 개발자">풀스택 개발자</option>
          <option value="백엔드 개발자">백엔드 개발자</option>
          <option value="프론트엔드 개발자">프론트엔드 개발자</option>
        </select>
      </div>
      <div class="question">
        <label>이름 *</label>
        <input type="text" id="username" placeholder="예: 홍길동">
      </div>
      <div class="btn-area">
        <button class="btn-secondary" onclick="goBackToStart()">이전</button>
        <button class="btn" onclick="goToSoftSkill()">다음</button>
      </div>
    </div>
  </div>

  <!-- (3) Soft Skill -->
  <div id="softskill-screen" class="hidden">
    <div class="header"><h1>공통 Soft Skill</h1></div>
    <div class="container" id="softskill-questions"></div>
    <div class="btn-area">
      <button class="btn" onclick="validateSoftSkill()">다음 (Hard Skill)</button>
    </div>
  </div>

  <!-- (4) Hard Skill -->
  <div id="hardskill-screen" class="hidden">
    <div class="header"><h1>공통 Hard Skill</h1></div>
    <div class="container" id="hardskill-questions"></div>
    <div class="btn-area">
      <button class="btn-secondary" onclick="document.getElementById('softskill-screen').classList.remove('hidden');document.getElementById('hardskill-screen').classList.add('hidden');">이전</button>
      <button class="btn" onclick="validateHardSkill()">다음 (개인 성장 목표)</button>
    </div>
  </div>

  <!-- (5) 개인 성장 목표 -->
  <div id="goal-screen" class="hidden">
    <div class="header"><h1>개인 성장 목표</h1></div>
    <div class="container">
      <textarea id="personal-goal" rows="6" style="width:100%;"></textarea>
      <div class="btn-area">
        <button class="btn-secondary" onclick="goBackToHardSkill()">이전</button>
        <button class="btn" onclick="validateGoal()">제출하기</button>
      </div>
    </div>
  </div>

  <!-- (6) 결과 화면 -->
  <div id="result-screen" class="hidden">
    <div class="header"><h1>나의 CDP 결과</h1></div>
    <div class="container">
      <h2>개인 성장 목표</h2>
      <div id="goal-section" class="goal-box"></div>
    </div>
  </div>

</body>
</html>

